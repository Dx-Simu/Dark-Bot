<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyCloud Mobile Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; overflow-x: hidden; }
        .neon-border { border: 1px solid #0f0; box-shadow: 0 0 5px #0f0; }
        #editor { 
            background: #050505; color: #0f0; border: 1px solid #050; 
            width: 100%; height: 350px; padding: 10px; font-size: 14px; 
            outline: none; border-radius: 5px;
        }
        .terminal { 
            background: #000; height: 200px; border: 1px solid #030; 
            overflow-y: auto; font-size: 12px; padding: 5px;
        }
        /* Mobile Specific Adjustment */
        @media (max-width: 768px) {
            #editor { height: 300px; }
            .sidebar { width: 100% !important; border-right: none !important; border-bottom: 1px solid #050; }
            .main-layout { flex-direction: column; }
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="p-3 border-b border-green-900 flex flex-wrap justify-between items-center bg-black">
        <h1 class="text-lg font-bold">PY_HOST_PRO</h1>
        <div class="flex gap-2 text-[10px]">
            <span id="save-status" class="opacity-50 mt-1">IDLE</span>
            <input id="new-name" type="text" placeholder="app.py" class="bg-black border border-green-800 px-1 w-20 outline-none">
            <button onclick="createNew()" class="bg-green-900 px-2 rounded">NEW</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden main-layout">
        <aside class="sidebar w-64 p-3 overflow-y-auto bg-black border-r border-green-900">
            <h2 class="text-[10px] mb-2 opacity-50 uppercase">Projects</h2>
            <div id="file-list" class="space-y-1 mb-4"></div>

            <h2 class="text-[10px] mb-2 opacity-50 uppercase">PIP Package Installer</h2>
            <div class="flex gap-1">
                <input id="pip-pkg" type="text" placeholder="e.g. requests" class="w-full bg-black border border-green-800 p-1 text-xs outline-none">
                <button onclick="pipInstall()" class="bg-green-700 text-black px-2 font-bold text-xs">INSTALL</button>
            </div>
            <div class="mt-4 text-[9px] text-green-700 italic">
                Pre-installed: os, sys, time, json, math, random...
            </div>
        </aside>

        <main class="flex-1 p-3 flex flex-col gap-3 overflow-y-auto">
            <div class="flex justify-between items-center">
                <span id="current-file" class="text-xs text-white underline">No File</span>
                <div class="flex gap-2">
                    <button onclick="deploy()" class="bg-green-600 text-black px-3 py-1 text-xs font-bold rounded">RUN</button>
                    <button onclick="stop()" class="bg-red-800 text-white px-3 py-1 text-xs font-bold rounded">STOP</button>
                </div>
            </div>

            <textarea id="editor" spellcheck="false" oninput="autoSave()"></textarea>

            <div class="terminal-container">
                <div class="text-[9px] mb-1 opacity-50 uppercase">Output Console</div>
                <div id="terminal" class="terminal"></div>
            </div>
        </main>
    </div>

    <script>
        const socket = io();
        let activeFile = "";
        let saveTimer;

        async function fetchFiles() {
            const res = await fetch('/api/projects');
            const data = await res.json();
            document.getElementById('file-list').innerHTML = data.map(p => `
                <div onclick="loadFile('${p.name}')" class="p-2 cursor-pointer border border-green-900/30 hover:bg-green-900/20 text-xs flex justify-between">
                    <span>${p.name}</span>
                    <span class="${p.status === 'Running' ? 'text-green-500' : 'text-gray-600'}">‚óè</span>
                </div>
            `).join('');
        }

        async function loadFile(name) {
            activeFile = name;
            document.getElementById('current-file').innerText = name;
            const res = await fetch(`/api/read/${name}`);
            document.getElementById('editor').value = await res.text();
            fetchFiles();
        }

        function autoSave() {
            document.getElementById('save-status').innerText = "TYPING...";
            clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                if(!activeFile) return;
                await fetch('/api/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ filename: activeFile, content: document.getElementById('editor').value })
                });
                document.getElementById('save-status').innerText = "SAVED";
            }, 1500);
        }

        function deploy() { socket.emit('run-script', { filename: activeFile }); }
        function stop() { socket.emit('stop-script', { filename: activeFile }); }
        
        function pipInstall() {
            const pkg = document.getElementById('pip-pkg').value;
            if(!pkg) return;
            logToTerminal(`[SYSTEM] Initiating install: ${pkg}...`, 'sys');
            socket.emit('terminal-input', `pip install ${pkg}`);
        }

        function createNew() {
            const val = document.getElementById('new-name').value;
            if(!val) return;
            activeFile = val.endsWith('.py') ? val : val + '.py';
            document.getElementById('editor').value = "import os, sys, time\n\nprint(f'System: {os.name}')\nprint('Running heavy module check...')";
            autoSave();
            fetchFiles();
        }

        function logToTerminal(data, type) {
            const term = document.getElementById('terminal');
            const div = document.createElement('div');
            div.style.color = type === 'error' ? '#f33' : (type === 'sys' ? '#ff0' : '#0f0');
            div.innerText = `> ${data}`;
            term.appendChild(div);
            term.scrollTop = term.scrollHeight;
        }

        socket.on('terminal-data', (d) => logToTerminal(d.data, d.type));
        socket.on('status-change', () => fetchFiles());
        fetchFiles();
    </script>
</body>
    </html>
